<!DOCTYPE html>
<html lang="en">
<head>
    {% include head.html %}
    {% include library_raphael.html %}
    <!-- MDBootstrap Datatables  -->
    <link href="js/MDB/datatables.min.css" rel="stylesheet">
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.7.4/js/mdb.min.js"></script>
    <!-- MDBootstrap Datatables  -->
    <script type="text/javascript" src="js/MDB/datatables.min.js"></script>

    <!-- My Scripts -->
    <script src="js/NNDatas.js"></script>
    <script src="js/NN.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.1/bootstrap-slider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.1/css/bootstrap-slider.min.css">
</head>

<body>
{% include nav.html %}
<main role="main" class="container" style="max-width: 95%">

    <h1>Réseau neuronnal</h1>

    <div class="row mt-2 col-md-12">
        <div class="col-sm-4">
            <div>
                <canvas id="can" width="280" height="280" style="top:10%;left:10%;border:2px solid; cursor:crosshair"></canvas>
            </div>

            <div class="container">
                <div style="padding-bottom:5px;"><input type="checkbox" id="preprocessing"><span style="margin-left:5px;">Display Preprocessing</span></div>
                <div style="padding-bottom:5px;"><input type="checkbox" id="scaleStrokeWidth" checked="true"><span style="margin-left:5px;">Scale Stroke Width</span></div>
                <div style="float:left;padding-right:10px;"><input type="button" value="clear" id="clr" size="23" onclick="erase()"></div>
                <div style="float:left;"><input type="button" value="recognize" id="recognize" size="23" onclick="recognize()"></div>
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#modifyWeights">Modifier le réseau</button>
                <div id="nnInput"></div>
            </div>

            <!-- Choose arc modal -->
            <div class="modal fade" id="modifyWeights" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Modifier le réseau de neuronne</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col" align="center">
                                    Couche 1<br>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="buttonPressed(1, $(layer1spinner).val(), 'neuron')"><i class="far fa-circle"></i></button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="buttonPressed(1, $(layer1spinner).val(), 'wOut')"><i class="fas fa-sign-out-alt"></i></button>
                                    </div>
                                    <div>
                                        <div style="padding-top: 20px; padding-bottom: 15px">
                                            <input id="layer1slider" type="text" data-slider-min="0" data-slider-max="784" data-slider-step="1" data-slider-value="1">
                                        </div>
                                        <div class="input-group">
                                            <input id="layer1spinner" type="number" class="form-control" value="1" min="1" max="784" step="1">
                                            <div class="input-group-append">
                                                <span class="input-group-text">/784</span>
                                            </div>
                                        </div>
                                        <script>
                                            $("#layer1slider").slider({
                                                orientation: 'vertical'
                                            });

                                            // Synchronize the value of the spinner and the one of the slider
                                            $("#layer1slider").on("slide", function(slideEvt) {
                                                $("#layer1spinner").val(slideEvt.value);
                                            });

                                            $("#layer1spinner").on("input", function(spinEvent) {
                                                $("#layer1slider").slider('setValue', $("#layer1spinner").val());
                                            });
                                        </script>
                                    </div>
                                </div>
                                <div class="col" align="center">
                                    Couche 2<br>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="buttonPressed(2, $(layer1spinner2).val(), 'wIn')"><i class="fas fa-sign-in-alt"></i></button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="buttonPressed(2, $(layer1spinner2).val(), 'neuron')"><i class="far fa-circle"></i></button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="buttonPressed(2, $(layer1spinner2).val(), 'wOut')"><i class="fas fa-sign-out-alt"></i></button>
                                    </div>
                                    <div>
                                        <div style="padding-top: 20px; padding-bottom: 15px">
                                            <input id="layer1slider2" type="text" data-slider-min="0" data-slider-max="500" data-slider-step="1" data-slider-value="1">
                                        </div>
                                        <div class="input-group">
                                            <input id="layer1spinner2" type="number" class="form-control" value="1" min="1" max="500" step="1">
                                            <div class="input-group-append">
                                                <span class="input-group-text">/500</span>
                                            </div>
                                        </div>
                                        <script>
                                            $("#layer1slider2").slider({
                                                orientation: 'vertical'
                                            });

                                            // Synchronize the value of the spinner and the one of the slider
                                            $("#layer1slider2").on("slide", function(slideEvt) {
                                                $("#layer1spinner2").val(slideEvt.value);
                                            });

                                            $("#layer1spinner2").on("input", function(spinEvent) {
                                                $("#layer1slider2").slider('setValue', $("#layer1spinner").val());
                                            });
                                        </script>
                                    </div>
                                </div>
                                <div class="col" align="center">
                                    Couche 3<br>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="buttonPressed(3, $(layer1spinner3).val(), 'wIn')"><i class="fas fa-sign-in-alt"></i></button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="buttonPressed(3, $(layer1spinner3).val(), 'neuron')"><i class="far fa-circle"></i></button>
                                    </div>
                                    <div>
                                        <div style="padding-top: 20px; padding-bottom: 15px">
                                            <input id="layer1slider3" type="text" data-slider-min="0" data-slider-max="10" data-slider-step="1" data-slider-value="1">
                                        </div>
                                        <div class="input-group">
                                            <input id="layer1spinner3" type="number" class="form-control" value="1" min="1" max="10" step="1">
                                            <div class="input-group-append">
                                                <span class="input-group-text">/10</span>
                                            </div>
                                        </div>
                                        <script>
                                            $("#layer1slider3").slider({
                                                orientation: 'vertical'
                                            });

                                            // Synchronize the value of the spinner and the one of the slider
                                            $("#layer1slider3").on("slide", function(slideEvt) {
                                                $("#layer1spinner3").val(slideEvt.value);
                                            });

                                            $("#layer1spinner3").on("input", function(spinEvent) {
                                                $("#layer1slider3").slider('setValue', $("#layer1spinner").val());
                                            });
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Neuron information modal -->
            <div class="modal fade" id="neuronModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Neurone n°<span class="currentNeuronNumber"></span></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Couche : <span id="neuronLayerInfo"></span></p>
                            <div id="neuronModalInformationForSpecificLayers"></div>
                            Valeur : <span id="neuronValueInfo"></span>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outgoing neurons weights modal -->
            <div class="modal fade" id="outWeightModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Poids de sorties du neurone n°<span class="currentNeuronNumber"></span></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="weightsTable">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <!-- TODO : ajouter un bouton pour valider les données -->
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Store current information for modals
                let neuronIndexToDisplay = null;
                let neuronIndexToDisplayLayer = null;

                function buttonPressed(layer, neuron, action) {
                    setneuronIndexToDisplayLayer(layer);
                    setNeuronIndexToDisplay(neuron);

                    if (action === "neuron") {
                        refreshNeuronWindowInfo();
                        $('#neuronModal').modal('toggle');
                    }
                    else if (action === "wOut") {
                        refreshWeightOutWindowInfo();
                        $('#outWeightModal').modal('toggle');
                    }
                }

                function setneuronIndexToDisplayLayer(newValue) {
                    neuronIndexToDisplayLayer = newValue;
                }

                function setNeuronIndexToDisplay(newValue) {
                    neuronIndexToDisplay = newValue;

                    $('.currentNeuronNumber').text(neuronIndexToDisplay);
                }

                function refreshNeuronWindowInfo() {
                    $('#neuronLayerInfo').text(neuronIndexToDisplayLayer);


                    let correspondingNeuron = new Neuron(neuronIndexToDisplay, neuronIndexToDisplayLayer, null);
                    $('#neuronValueInfo').text(correspondingNeuron.value);
                    let informationForSpecialNeuron = $('#neuronModalInformationForSpecificLayers');
                    informationForSpecialNeuron.text("");
                    if (neuronIndexToDisplayLayer === 1) {
                        let correspondingPixelX = Math.floor((neuronIndexToDisplay-1)/28);
                        let correspondingPixelY = (neuronIndexToDisplay-1)%28;
                        informationForSpecialNeuron.text(`Pixel de l'image de coordonnée : (${correspondingPixelX}, ${correspondingPixelY})`);
                    }
                    else if (neuronIndexToDisplayLayer === 3) {
                        informationForSpecialNeuron.text(`Probabilité du chiffre ${correspondingNeuron.number} : ${correspondingNeuron.value*100} %`);
                    }
                }

                function refreshWeightOutWindowInfo() {

                    let modalDiv = $('#weightsTable');
                    let tableId = "tableOutWeight";
                    modalDiv.empty(); // Free up what was inside

                    let neuronOut = new Neuron(neuronIndexToDisplay, neuronIndexToDisplayLayer);
                    let currentWeight = new Weight(neuronOut, null, neuronIndexToDisplayLayer);

                    // Fill up the table
                    var table = $('<table>').addClass('table');
                    table.attr("id", tableId);

                    let head = $('<thead>');
                    let headTr= $('<tr>');
                    let headNames = ["Poids n°", "Valeur actuelle", "Valeur par défaut"];
                    for (let i = 0; i < headNames.length; i++) {
                        headTr.append($('<th>').html(headNames[i]));
                    }
                    head.append(headTr);
                    table.append(head);

                    let tableBody = $('<tbody>');
                    let layerArray = currentWeight.layerArray;
                    for(let i=0; i < layerArray.length; i++) {
                        currentWeight.n2 = new Neuron(i, neuronIndexToDisplayLayer+1); // He is one layer further
                        let curValue = currentWeight.weight;
                        let defaultValue = currentWeight.defaultWeight;
                        let row = $('<tr>');
                        for (let j = 0; j < headNames.length; j++) {
                            let rowCol = $('<td>');
                            if (j === 0) {
                                rowCol.html(`${i+1}`)
                            } else if (j === 1) {
                                // We hide a span with the value because the sorting won't happen on the input directly
                                // There is no need to change the span text with the inut one as the sorting does not refresh when resorting
                                rowCol.html(
                                    `<span  class="d-none">${curValue}</span>
                                    <input type="number" step="0.1" class="form-control" value=${curValue}>`);
                            } else if (j === 2) {
                                rowCol.html(`${defaultValue}`);
                            }
                            row.append(rowCol);
                        }
                        tableBody.append(row);
                    }
                    table.append(tableBody);
                    modalDiv.append(table);

                    $(`#${tableId}`).DataTable(
                        {
                            "language": {
                                "decimal":        ",",
                                "emptyTable":     "Aucune entrée dans la table",//"No data available in table",
                                "info":           "Montrer _START_ jusqu'à _END_ de _TOTAL_ entrés",//"Showing _START_ to _END_ of _TOTAL_ entries",
                                "infoEmpty":      "Montrer 0 jusqu'à 0 de 0 entrés",//"Showing 0 to 0 of 0 entries",
                                "infoFiltered":   "(filtré de _MAX_ entrés totales)",//"(filtered from _MAX_ total entries)",
                                "infoPostFix":    "",
                                "thousands":      ".",
                                "lengthMenu":     "Montrer _MENU_ entrés",//"Show _MENU_ entries",
                                "loadingRecords": "Chargement...",//"Loading...",
                                "processing":     "Traitement...",//"Processing...",
                                "search":         "Chercher :",
                                "zeroRecords":    "Aucun enregistrements correspondants trouvés", //"No matching records found",
                                "paginate": {
                                    "first":      "Premier",
                                    "last":       "Dernier",
                                    "next":       "Prochain",
                                    "previous":   "Précédent"
                                },
                                "aria": {
                                    "sortAscending":  ": activer pour trier la colonne par ordre croissant",//": activate to sort column ascending",
                                    "sortDescending": ": activer pour trier la colonne par ordre décroissant"
                                }
                            }
                        }
                    );
                    $('.dataTables_length').addClass('bs-select');
                }

            </script>

            <br><br>
            <!--
            <div>
                <canvas id="network" width="784" height="30" style="top:10%;left:10%;border:2px solid;"></canvas>
            </div>
            -->

            <script>
                /*
                var canvas = document.getElementById("network");
                var ctxNetwork = canvas.getContext("2d");

                var w = 784;

                // TODO : refactor ! (seulement la hauteur et la facon de calculer la lightness change)
                function drawFirstLayer(data) {
                    let size = 1;
                    for (let i = 0; i < data.length; i++) {
                        let curData = data[i];
                        // [-1, 1] = [blanc, noir]
                        let lightVal = 100 - 50*(curData +1);
                        ctxNetwork.fillStyle = "hsl(0,0%," + lightVal + "%)";
                        ctxNetwork.fillRect(i,0,size,10);
                    }
                }

                function drawSecondLayer(data) {
                    let size = w/data.length;
                    for (let i = 0; i < data.length; i++) {
                        let curData = data[i];
                        // [0, 1] = [blanc, noir]
                        let lightVal = 100 - 100*(curData);
                        ctxNetwork.fillStyle = "hsl(0,0%," + lightVal + "%)";
                        ctxNetwork.fillRect(i*size,10,size,10);
                    }
                }


                function drawOutput(data) {
                    let size = w/data.length;
                    for (let i = 0; i < data.length; i++) {
                        let curData = data[i];
                        // [0, 1] = [blanc, noir]
                        let lightVal = 100 - 100*(curData);
                        ctxNetwork.fillStyle = "hsl(0,0%," + lightVal + "%)";
                        ctxNetwork.fillRect(i*size,20,size,10);
                    }
                }
                */
            </script>

            <div class="container">
                <p>
                    <br><br>
                    {% for i in (0 .. 9) %}
                <h5 style="float: left; margin-right: 1em;">{{ i }} :</h5>
                <div class="progress">
                    <div id="percentBar{{ i }}" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <br>
                {% endfor %}
                </p>

                <p class="lead">
                    Reconnu comme : <span id="nnOut"></span>
                </p>
            </div>
        </div>


        <div class="col-sm-8">

            <div id="neuralNetworkContainer">
            </div>

            <script src="js/NN_representation.js"></script>
        </div>

    </div>


</main>

</body>
</html>